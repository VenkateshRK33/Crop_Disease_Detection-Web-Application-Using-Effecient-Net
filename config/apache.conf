# KrishiRaksha Apache Configuration
# 
# This is a template configuration for Apache web server
# Copy to /etc/apache2/sites-available/krishiraksha.conf and customize
# 
# Usage:
#   1. Update ServerName with your domain
#   2. Update SSL certificate paths
#   3. Update DocumentRoot to your build directory
#   4. sudo a2enmod ssl rewrite proxy proxy_http headers deflate
#   5. sudo a2ensite krishiraksha
#   6. sudo apache2ctl configtest
#   7. sudo systemctl reload apache2

# HTTP - Redirect to HTTPS
<VirtualHost *:80>
    ServerName yourdomain.com
    ServerAlias www.yourdomain.com
    
    # Redirect all HTTP to HTTPS
    Redirect permanent / https://yourdomain.com/
</VirtualHost>

# HTTPS - Main Configuration
<VirtualHost *:443>
    ServerName yourdomain.com
    ServerAlias www.yourdomain.com
    ServerAdmin admin@yourdomain.com
    
    DocumentRoot /path/to/krishiraksha/frontend-react/build
    
    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/yourdomain.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/yourdomain.com/privkey.pem
    
    # SSL Security Settings
    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder off
    SSLCompression off
    SSLSessionTickets off
    
    # HSTS
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    
    # Logging
    ErrorLog ${APACHE_LOG_DIR}/krishiraksha-error.log
    CustomLog ${APACHE_LOG_DIR}/krishiraksha-access.log combined
    
    # Security Headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "no-referrer-when-downgrade"
    
    # Compression
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript
        AddOutputFilterByType DEFLATE application/javascript application/json application/xml
        AddOutputFilterByType DEFLATE image/svg+xml
    </IfModule>
    
    # Frontend Directory Configuration
    <Directory /path/to/krishiraksha/frontend-react/build>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        # React Router Support
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteCond %{REQUEST_FILENAME} !-l
        RewriteRule . /index.html [L]
        
        # Cache Control for index.html
        <FilesMatch "index\.html$">
            Header set Cache-Control "no-cache, no-store, must-revalidate"
            Header set Pragma "no-cache"
            Header set Expires "0"
        </FilesMatch>
        
        # Cache Static Assets
        <FilesMatch "\.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$">
            Header set Cache-Control "public, max-age=31536000, immutable"
        </FilesMatch>
    </Directory>
    
    # API Proxy to Backend
    ProxyPreserveHost On
    ProxyPass /api http://localhost:4000/api
    ProxyPassReverse /api http://localhost:4000/api
    
    # Health Check
    ProxyPass /health http://localhost:4000/health
    ProxyPassReverse /health http://localhost:4000/health
    
    # Uploads Directory (if serving directly)
    Alias /uploads /path/to/krishiraksha/uploads
    <Directory /path/to/krishiraksha/uploads>
        Options -Indexes
        Require all granted
        
        <FilesMatch "\.(jpg|jpeg|png|gif)$">
            Header set Cache-Control "public, max-age=86400"
        </FilesMatch>
    </Directory>
    
    # Deny access to hidden files
    <FilesMatch "^\.">
        Require all denied
    </FilesMatch>
    
    # Deny access to sensitive files
    <FilesMatch "\.(env|log|sql|bak)$">
        Require all denied
    </FilesMatch>
    
    # Error Documents
    ErrorDocument 404 /index.html
</VirtualHost>

# SSL Configuration (if using separate file)
<IfModule mod_ssl.c>
    SSLStaplingCache shmcb:/var/run/ocsp(128000)
</IfModule>
